# Google Authentication Scan Report
**Date:** 2025-11-23 20:26:23  
**Branch:** fix/google-auth-scan-20251123-202623

## Executive Summary

The application has **TWO separate Google authentication flows**:
1. **Popup Flow** (Student login) - Uses `NEXT_PUBLIC_GOOGLE_CLIENT_ID` with `id_token` response type
2. **NextAuth Flow** (Admin login) - Uses `GOOGLE_CLIENT_ID` + `GOOGLE_CLIENT_SECRET` with `code` response type

**CRITICAL ISSUE:** The redirect URI `/api/auth/google/callback` is **NOT registered** in Google Cloud Console, causing the "No token received" error.

## Key Findings

### ✅ What's Working
- MongoDB connection is healthy
- User model schema is correct with unique constraints
- User persistence logic works (finds or creates users)
- Build completes successfully
- TypeScript compilation passes
- Linting passes

### ❌ Critical Issues

1. **Redirect URI Mismatch (PRIMARY ISSUE)**
   - **Error:** `redirect_uri_mismatch` from Google
   - **Cause:** `/api/auth/google/callback` not registered in Google Cloud Console
   - **Impact:** Google redirects with error instead of `id_token`, causing "No token received"
   - **Fix Required:** Add redirect URIs to Google Console

2. **Build Warning**
   - **Warning:** Dynamic server usage in callback route
   - **Location:** `app/api/auth/google/callback/route.ts`
   - **Fix Required:** Add `export const dynamic = 'force-dynamic'`

3. **Environment Variable Inconsistency**
   - Code uses both `NEXT_PUBLIC_GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_ID`
   - They should contain the same Client ID value
   - NextAuth requires `GOOGLE_CLIENT_SECRET` (for code flow) but popup flow doesn't need it (id_token flow)

### ⚠️ Observations

1. **Two Auth Flows:**
   - Popup flow: Direct OAuth with `id_token` response (no secret needed)
   - NextAuth flow: OAuth with `code` response (requires secret)
   - Both work but use different redirect URIs

2. **User Persistence:**
   - ✅ Works in `/api/auth/google/callback` (popup flow)
   - ✅ Works in `/api/users/google-login` (alternative endpoint)
   - ⚠️ NextAuth callbacks do NOT persist users (intentional - handled separately)

3. **NextAuth Configuration:**
   - GoogleProvider is conditionally enabled
   - `signIn` callback allows Google auth but doesn't create users
   - User creation must happen in separate API routes

## Technical Details

### Auth Packages
- `next-auth@^4.24.11` - NextAuth.js for admin authentication
- `google-auth-library@^9.14.2` - Google OAuth token verification
- `mongoose@^8.19.1` - MongoDB ODM
- `bcryptjs@^3.0.2` - Password hashing

### Environment Variables Required

**For Popup Flow (Student Login):**
```env
NEXT_PUBLIC_GOOGLE_CLIENT_ID=687330245585-dfd49ge9q2svhljs9sdtnopompltl75v.apps.googleusercontent.com
```

**For NextAuth Flow (Admin Login):**
```env
GOOGLE_CLIENT_ID=687330245585-dfd49ge9q2svhljs9sdtnopompltl75v.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=<your-client-secret>
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=<secure-random-string>
```

### Redirect URIs Needed in Google Console

**For Popup Flow:**
- `http://localhost:3000/api/auth/google/callback`
- `https://ms-education-xi.vercel.app/api/auth/google/callback`

**For NextAuth Flow (already registered):**
- `http://localhost:3000/api/auth/callback/google`
- `https://ms-education-xi.vercel.app/api/auth/callback/google`

### Database Schema

**User Model (Mongoose):**
- `email` (unique, required)
- `mobile` (unique, required)
- `name` (required)
- `password` (required)
- `profileImage` (optional, from Google)
- Additional profile fields (optional)

**User Creation Flow:**
1. Google provides: `email`, `name`, `picture`, `sub`
2. Code generates: `mobile` (from sub), `password` (from sub)
3. User is created or found by email
4. Profile image updated if available

## Recommended Fixes (Priority Order)

### 1. CRITICAL: Add Redirect URI to Google Console
**Action Required:** Go to [Google Cloud Console](https://console.cloud.google.com/auth/clients/687330245585-dfd49ge9q2svhljs9sdtnopompltl75v.apps.googleusercontent.com?project=mseducaion) and add:
- `http://localhost:3000/api/auth/google/callback`
- `https://ms-education-xi.vercel.app/api/auth/google/callback`

**Impact:** This will fix the "No token received" error immediately.

### 2. Fix Build Warning
**File:** `app/api/auth/google/callback/route.ts`
**Add:** `export const dynamic = 'force-dynamic';` at the top

### 3. Verify Environment Variables
**Check:** `.env.local` has `NEXT_PUBLIC_GOOGLE_CLIENT_ID` set
**Check:** Vercel has `NEXT_PUBLIC_GOOGLE_CLIENT_ID` set for production

### 4. Optional: Consolidate Environment Variables
**Consider:** Using same Client ID for both flows:
```env
NEXT_PUBLIC_GOOGLE_CLIENT_ID=687330245585-dfd49ge9q2svhljs9sdtnopompltl75v.apps.googleusercontent.com
GOOGLE_CLIENT_ID=687330245585-dfd49ge9q2svhljs9sdtnopompltl75v.apps.googleusercontent.com
```

## Testing Checklist

After fixes:
- [ ] Add redirect URIs to Google Console
- [ ] Wait 1-5 minutes for Google to update
- [ ] Test popup flow: Click "Continue with Google" → Popup opens → Login → Redirects back → User created → Popup closes → User logged in
- [ ] Verify user exists in MongoDB
- [ ] Test with new user (registration)
- [ ] Test with existing user (login)
- [ ] Check browser console for errors
- [ ] Verify no "No token received" error

## Files Modified (Will be in Phase C)

- `app/api/auth/google/callback/route.ts` - Add dynamic export
- `lib/auth.ts` - Potentially normalize env var names
- Documentation updates

## Rollback Plan

If fixes cause issues:
1. `git revert` commits from fix branch
2. Remove redirect URIs from Google Console (if needed)
3. Revert environment variable changes

---

**Status:** ✅ Scan Complete - Ready for Phase C (Fixes) after approval

